<!DOCTYPE html>
<html>
  <head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
      /* body {
        font-family: 'IBM Plex Sans', sans-serif;
        font-size: 12px;
      }
      h4 {
        font-weight: bold;
      }
      h5, h6 {
        font-weight: bold;
        margin: 0;
      }
      p {
        font-size: 12.4px;
        margin: 0;
      }
      .form-select, .form-control {
        font-size: 12.4px;
      }
      .required:after {
        content:" *";
        color: red;
      }
      .form-label {
        font-weight: bold;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .loader {
        width: 48px;
        height: 48px;
        border: 5px solid #f3f3f3;
        border-radius: 50%;
        border-top: 5px solid #3498db;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .sidebar-layout {
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .sidebar-layout::-webkit-scrollbar {
        display: none;
      }

      .sidebar-header {
        flex: 0 0 auto;
        padding: 1rem;
        background: white;
        border-bottom: 1px solid #dee2e6;
      }

      .sidebar-content {
        flex: 1 1 auto;
        overflow-y: auto;
        padding: 1rem;
      }

      .sidebar-header, .sidebar-footer {
  flex-shrink: 0;
}

#attr-form {
  display: flex;
  flex-direction: column;
  flex: 1;
  overflow: hidden;
}

      .sidebar-footer {
        flex: 0 0 auto;
        padding: 1rem;
        background: white;
        border-top: 1px solid #dee2e6;
      }
      .flatpickr-calendar {
        transform: scale(0.85);
        transform-origin: top left;
        animation: none !important;
      }
      .flatpickr-calendar.open {
        transform: scale(0.85);
        transform-origin: top center;
        left: 50% !important;
        transform: translate(-50%, -5px) scale(0.85) !important;
      }
      .empty-field {
        background-color: #eaeced !important;
        color: #6c757d !important;
      }
      .select2-container {
        width: 100% !important;
      }
      .select2-dropdown {
        max-width: 300px;
        z-index: 9999;
        position: fixed;
        left: 0 !important;
        margin-left: 1rem;
      }
      .select2-results__option {
        font-size: 12.4px;
        padding: 4px 8px;
      }
      .select2-container .select2-selection--single {
        font-size: 12.4px;
      }
      .select2-results__options {
        font-size: 12.4px;
      }
      .select2-container--bootstrap-5 .select2-dropdown .select2-results__options .select2-results__option {
        font-size: 12.4px;
      }
      .select2-container--bootstrap-5 .select2-dropdown .select2-search .select2-search__field {
        font-size: 12.4px;
      }
      .select2-container--bootstrap-5 .select2-results > .select2-results__options {
        max-height: 200px;
        overflow-y: auto;
      }

      #id-select + .select2-container .select2-selection__rendered {
        font-size: 12.4px;
      }
      .archived-section {
        opacity: 0.8;
  margin-top: auto;
      }
      .select2-container--bootstrap-5 .select2-selection--single .select2-selection__clear {
        height: 0.5rem;
        width: 0.5rem;
      }
      .select2-container--bootstrap-5 .select2-dropdown .select2-search {
        padding: 0.375rem;
      }

  #archivedFields {
    margin-bottom: 2rem;
  }

  .archived-section {
  margin-bottom: 1rem;
}

#archivedFields {
  margin-bottom: 0;
  padding-bottom: 1rem;
}

.sidebar-content {
  padding-bottom: 0;
}

#attributes-container, #archived-attributes-container {
  margin-bottom: 0;
} */

body {
 font-family: 'IBM Plex Sans', sans-serif;
 font-size: 12px;
}

h4 {
 font-weight: bold;
}

h5, h6 {
 font-weight: bold;
 margin: 0;
}

p {
 font-size: 12.4px;
 margin: 0;
}

.form-select, .form-control {
 font-size: 12.4px;
}

.required:after {
 content:" *";
 color: red;
}

.form-label {
 font-weight: bold;
}

.loading-overlay {
 position: fixed;
 top: 0;
 left: 0;
 width: 100%;
 height: 100%;
 background: rgba(255, 255, 255, 0.8);
 display: none;
 justify-content: center;
 align-items: center;
 z-index: 1000;
}

.loader {
 width: 48px;
 height: 48px;
 border: 5px solid #f3f3f3;
 border-radius: 50%;
 border-top: 5px solid #3498db;
 animation: spin 1s linear infinite;
}

@keyframes spin {
 0% { transform: rotate(0deg); }
 100% { transform: rotate(360deg); }
}

.sidebar-layout {
 display: flex;
 flex-direction: column;
 height: 100vh;
 overflow: hidden;
 -ms-overflow-style: none;
 scrollbar-width: none;
}

.sidebar-layout::-webkit-scrollbar {
 display: none;
}

#attr-form {
 display: flex;
 flex-direction: column;
 flex: 1;
 overflow: hidden;
}

.sidebar-header {
 flex: 0 0 auto;
 padding: 1rem;
 background: white;
 border-bottom: 1px solid #dee2e6;
}

.sidebar-content {
 flex: 1;
 overflow-y: auto;
 padding: 1rem 1rem 0;
}

.sidebar-footer {
 flex: 0 0 auto;
 padding: 1rem;
 background: white;
 border-top: 1px solid #dee2e6;
}

.flatpickr-calendar {
 transform: scale(0.85);
 transform-origin: top left;
 animation: none !important;
}

.flatpickr-calendar.open {
 transform: scale(0.85);
 transform-origin: top center;
 left: 50% !important;
 transform: translate(-50%, -5px) scale(0.85) !important;
}

.empty-field {
 background-color: #eaeced !important;
 color: #6c757d !important;
}

.select2-container {
 width: 100% !important;
}

.select2-dropdown {
 max-width: 300px;
 z-index: 9999;
 position: fixed;
 left: 0 !important;
 margin-left: 1rem;
}

.select2-results__option {
 font-size: 12.4px;
 padding: 4px 8px;
}

.select2-container .select2-selection--single {
 font-size: 12.4px;
}

.select2-results__options {
 font-size: 12.4px;
}

.select2-container--bootstrap-5 .select2-dropdown .select2-results__options .select2-results__option {
 font-size: 12.4px;
}

.select2-container--bootstrap-5 .select2-dropdown .select2-search .select2-search__field {
 font-size: 12.4px;
}

.select2-container--bootstrap-5 .select2-results > .select2-results__options {
 max-height: 200px;
 overflow-y: auto;
}

#id-select + .select2-container .select2-selection__rendered {
 font-size: 12.4px;
}

.select2-container--bootstrap-5 .select2-selection--single .select2-selection__clear {
 height: 0.5rem;
 width: 0.5rem;
}

.select2-container--bootstrap-5 .select2-dropdown .select2-search {
 padding: 0.375rem;
}

.archived-section {
 margin: auto 0 0.5rem;
 opacity: 0.8;
}

#archivedFields {
 padding-bottom: 0.5rem;
 margin-bottom: 0;
}

#attributes-container, #archived-attributes-container {
 margin-bottom: 0;
}
    </style>
  </head>
  <body>
    <div id="loading-overlay" class="loading-overlay">
      <div class="loader"></div>
    </div>

    <div class="sidebar-layout">
      <!-- Fixed Header -->
      <header class="sidebar-header">
        <div class="d-grid gap-2">
          <button class="btn btn-sm btn-primary" onclick="toggleSpinner(this, 'showUserConsole')">‚Üê Back to User Console</button>
        </div>
        <hr>
        <div>
          <h6 id="form-header">Update Attributes</h6>
          <p class="mt-2" id="form-description"></p>
        </div>
      </header>

      <form id="attr-form">
        <!-- Scrollable Content -->
        <main class="sidebar-content">
          <div class="mb-3">
            <label id="id-label" for="id-select" class="form-label"></label>
            <select class="form-select" id="id-select">
              <option value="" selected disabled>Select ID</option>
            </select>
          </div>
          <div id="attributes-container"></div>

          <div class="archived-section mt-4">
            <button class="btn btn-sm btn-outline-secondary w-100"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#archivedFields">
              Show Archived Fields
            </button>
            <div id="archivedFields" class="collapse mt-3">
              <div id="archived-attributes-container"></div>
            </div>
          </div>
        </main>

        <!-- Fixed Footer -->
        <footer class="sidebar-footer">
          <div class="d-grid gap-2">
            <button type="submit" id="submit-btn" class="btn btn-sm btn-primary" disabled>Submit for Approval</button>
            <button type="button" class="btn btn-sm btn-secondary" onclick="toggleSpinner(this, 'showUserConsole')">Cancel</button>
          </div>
          <div id="alert" class="mt-2"></div>
        </footer>
      </form>
    </div>

    <script>
      let attributeType = '';
      let dropdownValues = {};
      let isInitialLoad = true;
      let originalValues = {};

      window.onload = function() {
        // Get attribute type from URL parameter or template value
        const params = new URLSearchParams(window.location.search);
        const type = params.get('type') || '<?= attributeType ?>';

        if (type) {
          initializeForm(type);
        }
      };

      function showLoading() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.style.display = 'flex';
        }
      }

      function hideLoading() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.style.display = 'none';

          // Show form container after loading
          const form = document.getElementById('form-container');
          if (form) {
            form.style.display = 'block';
          }
        }
      }

      function initializeDatepickers() {
        const dateFields = [
          'planned-start-date', 'planned-end-date',
          'budget-start-date', 'budget-end-date'
        ];

        dateFields.forEach(field => {
          const input = document.getElementById(field);
          if (input) {
            flatpickr(input, {
              dateFormat: 'd-M-y',
              allowInput: true,
              allowEmpty: true,
              enableTime: false,
              parseDate: (datestr) => {
                if (!datestr || datestr.toLowerCase() === 'null') return null;
                return new Date(datestr);
              },
              onChange: function(selectedDates, dateStr, instance) {
                // Only trigger change if date actually changed
                const originalDate = originalValues[input.id];
                const newDate = dateStr || '';
                if (originalDate !== newDate) {
                  checkFormChanges();
                }
              }
            });
          }
        });
      }

      function initializeForm(type) {
        showLoading();
        attributeType = type;
        const isCommon = type === 'common';

        document.getElementById('form-header').textContent = `Update ${isCommon ? 'Common ID' : 'Item ID'} Attributes`;
        document.getElementById('form-description').textContent = `Update attributes for selected ${isCommon ? 'Common ID' : 'Item ID'}.`;
        document.getElementById('id-label').textContent = isCommon ? 'COMMON ID' : 'ITEM ID';

        google.script.run
          .withSuccessHandler(data => {
            loadFormData(data);
            if (isInitialLoad) {
              hideLoading();
              isInitialLoad = false;
            }
          })
          .withFailureHandler(error => {
            showAlert('danger', `Error loading form: ${error.message}`);
            hideLoading();
          })
          .getAttributeData(type);
      }

      function loadFormData(data) {
        const { ids, attributes, dropdowns, config } = data;
        dropdownValues = dropdowns || {};

        // Check if field is archived
        const isArchived = (fieldName) => {
          return Object.values(config).flat().includes(fieldName);
        };

        // Setup ID select
        const idSelect = document.getElementById('id-select');
        idSelect.innerHTML = '<option value="" selected disabled>Select ID</option>';
        ids.forEach(id => {
          const option = document.createElement('option');
          option.value = id;
          option.textContent = id;
          idSelect.appendChild(option);
        });

        // Clear containers
        const container = document.getElementById('attributes-container');
        const archivedContainer = document.getElementById('archived-attributes-container');
        container.innerHTML = '';
        archivedContainer.innerHTML = '';

        document.getElementById('submit-btn').disabled = true;

        // Create form fields
        attributes.forEach(attr => {
          const div = document.createElement('div');
          div.className = 'mb-3';

          const label = document.createElement('label');
          label.className = 'form-label';
          label.textContent = attr.name;

          let input;

          switch(attr.type) {
            case 'date':
              input = document.createElement('input');
              input.type = 'text';
              input.className = 'form-control datepicker';
              break;

            case 'dropdown':
              input = document.createElement('select');
              input.className = 'form-select';

              const defaultOption = document.createElement('option');
              defaultOption.value = '';
              defaultOption.disabled = true;
              defaultOption.selected = true;
              input.appendChild(defaultOption);

              if (dropdownValues[attr.name]) {
                dropdownValues[attr.name].forEach(value => {
                  const option = document.createElement('option');
                  option.value = value;
                  option.textContent = value;
                  input.appendChild(option);
                });
              }
              break;

            default:
              input = document.createElement('input');
              input.type = 'text';
              input.className = 'form-control';
              input.maxLength = attr.maxLength;
          }

          input.id = attr.name.replace(/\s+/g, '-').toLowerCase();
          input.disabled = true;

          // Change event listener
          input.addEventListener('change', function() {
            this.classList.toggle('empty-field', !this.value);
            checkFormChanges();
          });

          div.appendChild(label);
          div.appendChild(input);

          // Arrange as per container
          if (isArchived(attr.name)) {
            archivedContainer.appendChild(div);
          } else {
            container.appendChild(div);
          }
        });

        // Format selection
        function formatOption(option) {
          if (!option || !option.id) return option?.text || '';
          return $('<span>').text(option.text);
        }

        function formatSelection(option) {
          if (!option || !option.id || !option.text) {
            return $('<span class="empty-field">').text('');
          }
          return $('<span>').text(option.text);
        }

        // Initialize ID select
        $('#id-select').select2({
          theme: 'bootstrap-5',
          width: '100%',
          allowClear: false,
          placeholder: 'Select ID',
          matcher: function(params, data) {
            if (!params.term) return data;
            return data.text.toLowerCase().includes(params.term.toLowerCase()) ? data : null;
          }
        });

        // Initialize Select2 for dropdowns
        $('.form-select').not('#id-select').each(function() {
          $(this).select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: null,
            allowClear: true,
            templateResult: formatOption,
            templateSelection: formatSelection
          });
        });

        // Clear handler
        $('.form-select').not('#id-select').on('select2:clear', function(e) {
          $(this).val(null).trigger('change');
          checkFormChanges();
        });

        initializeDatepickers();
      }

      // Update id-select change handler
      $('#id-select').on('select2:select', function(e) {
        const selectedId = this.value;
        if (!selectedId) return;

        showLoading();

        google.script.run
          .withSuccessHandler(function(values) {
            if (values) {
              originalValues = {...values};

              // Enable and populate all form inputs
              document.querySelectorAll('#attributes-container input, #attributes-container select, #archived-attributes-container input, #archived-attributes-container select')
                .forEach(input => {
                  input.disabled = false;
                  const value = values[input.id];

                  if (input.classList.contains('form-select')) {
                    $(input).val(value).trigger('change');
                  } else if (input.classList.contains('datepicker')) {
                    input._flatpickr.setDate(value);
                  } else {
                    input.value = value;
                  }
                  input.classList.toggle('empty-field', !value);
                });
            }
            hideLoading();
          })
          .withFailureHandler(function(error) {
            console.error('Error loading values:', error);
            showAlert('danger', 'Failed to load values: ' + error.message);
            hideLoading();
          })
          .getCurrentValues(attributeType, selectedId);
      });

      function checkFormChanges() {
        const hasChanges = Object.entries(originalValues).some(([key, value]) => {
          const input = document.getElementById(key);
          if (!input) return false;

          let currentValue = input.value;
          let originalValue = value || '';

          // Handle date fields
          if (input.classList.contains('datepicker')) {
            const date = input._flatpickr.selectedDates[0];
            currentValue = date ? input._flatpickr.formatDate(date, 'd-M-y') : '';
            originalValue = value || '';
          }

          // Handle select2 fields
          if ($(input).hasClass('select2-hidden-accessible')) {
            currentValue = $(input).val() || '';
          }

          return currentValue !== originalValue;
        });

        document.getElementById('submit-btn').disabled = !hasChanges;
      }

      document.getElementById('attr-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const date1 = document.getElementById('common-attr-2')?.value;
        const date2 = document.getElementById('common-attr-3')?.value;

        if (date1 && date2 && new Date(date1) > new Date(date2)) {
          showAlert('danger', 'End date must be after start date');
          return;
        }

        const formData = {
          type: attributeType,
          id: document.getElementById('id-select').value,
          attributes: {}
        };

        const container = document.getElementById('attributes-container');
        container.querySelectorAll('input, select').forEach(input => {
          formData.attributes[input.id] = input.value;
        });

        document.getElementById('submit-btn').disabled = true;

        google.script.run
          .withSuccessHandler(handleSubmitSuccess)
          .withFailureHandler(handleSubmitError)
          .submitAttributeRequest(formData);
      });

      function handleSubmitSuccess() {
        showAlert('success', 'Request submitted successfully! Awaiting admin approval.');

        // Reset form
        $('#id-select').val('').trigger('change');
        document.getElementById('attr-form').reset();
        document.getElementById('submit-btn').disabled = true;

        // Disable all inputs
        document.querySelectorAll('#attributes-container input, #attributes-container select, #archived-attributes-container input, #archived-attributes-container select').forEach(input => {
          input.disabled = true;
          if ($(input).hasClass('select2-hidden-accessible')) {
            $(input).val(null).trigger('change');
          }
        });
      }

      function handleSubmitError(error) {
        hideLoading();
        showAlert('danger', `Error: ${error.message}`);
        const submitBtn = document.getElementById('submit-btn');
        if (submitBtn) {
          submitBtn.disabled = false;
        }
      }

      function showAlert(type, message) {
        const alertDiv = document.getElementById('alert');
        alertDiv.innerHTML = `
          <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `;
      }

      function toggleSpinner(btn, fn) {
        const btnText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Loading...';
        btn.disabled = true;

        google.script.run
          .withSuccessHandler(() => {
            btn.innerHTML = btnText;
            btn.disabled = false;
          })
          .withFailureHandler(() => {
            btn.innerHTML = btnText;
            btn.disabled = false;
          })[fn]();
      }
    </script>
  </body>
</html>